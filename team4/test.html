<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LingoChat - Ù†Ø³Ø®Ù‡ Ú©Ø§Ù…Ù„</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@100;400;700&display=swap');
        body { font-family: 'Vazirmatn', sans-serif; }
        .messages-container::-webkit-scrollbar { width: 6px; }
        .messages-container::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .modal-active { display: flex !important; }
        .recording-active { animation: pulse 1.5s infinite; color: #ef4444; background-color: #fee2e2; border: 1px solid red; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
        
        .notification-toast {
            position: fixed;
            top: 20px;
            left: 20px;
            max-width: 350px;
            z-index: 1000;
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn {
            from { transform: translateX(-100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #ef4444;
            color: white;
            border-radius: 9999px;
            padding: 2px 6px;
            font-size: 10px;
            min-width: 18px;
            text-align: center;
        }
        .notification-panel {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            display: none;
            justify-content: flex-end;
            backdrop-filter: blur(4px);
        }
        .notification-panel.active {
            display: flex;
        }
        .notification-panel-content {
            width: 100%;
            max-width: 400px;
            background: white;
            height: 100%;
            overflow-y: auto;
            animation: slideInLeft 0.3s ease-out;
        }
        @keyframes slideInLeft {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }
        .notification-item {
            transition: all 0.2s;
        }
        .notification-item:hover {
            background: #f8fafc;
            transform: translateX(-2px);
        }
        .notification-item.unread {
            background: #eff6ff;
            border-right: 4px solid #3b82f6;
        }
    </style>
</head>
<body class="bg-gray-100 h-screen flex items-center justify-center p-4 text-right">

    <div class="bg-white w-full max-w-6xl h-[90vh] rounded-[40px] shadow-2xl flex overflow-hidden relative border border-gray-200">
        
        <!-- Ø³Ø§ÛŒØ¯Ø¨Ø§Ø± Ù…Ù†Ùˆ -->
        <div class="w-20 bg-slate-50 border-l flex flex-col items-center py-8 gap-8 relative">
            <div class="w-12 h-12 bg-blue-600 rounded-2xl flex items-center justify-center text-white font-bold text-xl shadow-lg">L</div>
            <button onclick="location.reload()" class="p-3 rounded-xl bg-blue-100 text-blue-600 shadow-sm relative">ğŸ’¬</button>
            <button onclick="toggleNotificationPanel()" class="p-3 rounded-xl text-gray-400 hover:bg-gray-200 transition relative">
                ğŸ””
                <span id="notification-badge" class="notification-badge hidden">0</span>
            </button>
            <button onclick="openSettings()" class="p-3 rounded-xl text-gray-400 hover:bg-gray-200 transition">âš™ï¸</button>
            <div class="mt-auto p-3 text-red-500 cursor-pointer flex flex-col items-center gap-1 hover:bg-red-50 rounded-xl" onclick="logout()">
                <span class="text-2xl">ğŸšª</span>
                <span class="text-[10px] font-bold">Ø®Ø±ÙˆØ¬</span>
            </div>
        </div>

        <!-- Ù„ÛŒØ³Øª Ú†Øªâ€ŒÙ‡Ø§ -->
        <div id="chats-sidebar" class="w-80 border-l flex flex-col bg-white">
            <div class="p-6">
                <div class="flex justify-between items-center">
                    <h2 class="text-2xl font-bold text-gray-800">Ú†Øªâ€ŒÙ‡Ø§</h2>
                    <button onclick="openCreateGroupModal()" class="w-8 h-8 bg-blue-600 text-white rounded-full flex items-center justify-center hover:bg-blue-700 transition shadow-md text-lg pb-1">+</button>
                </div>
                <div id="my-name-display" class="text-xs text-blue-600 font-bold mt-2 h-4"></div>
                <input type="text" 
                id="search-users-input" 
                placeholder="Ø¬Ø³ØªØ¬ÙˆÛŒ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†..." 
                class="w-full mt-4 bg-gray-100 p-3 rounded-xl outline-none text-sm focus:ring-2 ring-blue-100 transition"
                oninput="debounceSearchUsers(this.value)"
                onkeypress="if(event.key === 'Enter') searchUsers(this.value)">
            </div>
            <div id="chat-list" class="flex-1 overflow-y-auto px-4 space-y-2 pb-4 messages-container">
                <p class="text-center text-gray-400 mt-10 text-sm">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</p>
            </div>
        </div>

        <!-- Ø¨Ø®Ø´ Ø§ØµÙ„ÛŒ Ú†Øª -->
        <div id="chat-area" class="flex-1 flex flex-col bg-white">
            <div class="p-4 border-b flex items-center gap-4 cursor-pointer hover:bg-gray-50 transition" onclick="openGroupInfo()">
                <img id="active-user-img" src="https://via.placeholder.com/40" class="w-12 h-12 rounded-full border-2 border-blue-500 object-cover">
                <div class="flex-1">
                    <h3 id="active-user-name" class="font-bold text-gray-800">Ø§Ù†ØªØ®Ø§Ø¨ Ú†Øª</h3>
                    <div class="flex items-center gap-2 h-4">
                        <span id="online-status" class="text-xs text-green-500 font-bold hidden">â— Ø¢Ù†Ù„Ø§ÛŒÙ†</span>
                        <span id="typing-status" class="text-xs text-blue-500 italic hidden">Ø¯Ø± Ø­Ø§Ù„ Ù†ÙˆØ´ØªÙ†...</span>
                    </div>
                </div>
            </div>

            <div id="messages-box" class="flex-1 overflow-y-auto p-6 space-y-4 bg-[#f8fafc] messages-container">
                <div class="flex flex-col items-center justify-center h-full text-gray-300">
                    <span class="text-6xl mb-4">ğŸ’¬</span>
                    <p>Ù‡Ù†ÙˆØ² Ù¾ÛŒØ§Ù…ÛŒ Ù†ÛŒØ³Øª</p>
                </div>
            </div>

            <div id="input-area" class="p-4 bg-white border-t flex items-center gap-3 opacity-50 pointer-events-none transition-all">
                <label class="cursor-pointer text-2xl text-gray-400 hover:text-blue-500 p-2 rounded-full transition">
                    ğŸ“ <input type="file" id="file-input" class="hidden" onchange="uploadFile()">
                </label>
                
                <input id="msg-input" type="text" placeholder="Ù¾ÛŒØ§Ù… Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯..." class="flex-1 bg-gray-100 p-3 rounded-2xl outline-none focus:ring-2 ring-blue-500 transition">
                
                <button id="voice-btn" onclick="toggleVoiceRecording()" class="text-xl p-3 bg-gray-100 text-gray-500 hover:bg-red-100 hover:text-red-500 rounded-full transition shadow-sm" title="Ø¶Ø¨Ø· ØµØ¯Ø§">
                    ğŸ¤
                </button>

                <button onclick="sendText()" class="bg-blue-600 text-white px-6 py-3 rounded-2xl hover:bg-blue-700 shadow-lg transition font-bold transform active:scale-95">
                    â¤
                </button>
            </div>
        </div>

        <!-- Ù¾Ù†Ù„ Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù† -->
        <div id="notification-panel" class="notification-panel">
            <div class="notification-panel-content">
                <div class="p-6 border-b flex justify-between items-center bg-gradient-to-r from-blue-50 to-white">
                    <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                        ğŸ”” Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù†â€ŒÙ‡Ø§
                        <span id="panel-unread-count" class="bg-red-500 text-white text-xs px-2 py-1 rounded-full hidden">0</span>
                    </h2>
                    <div class="flex gap-2">
                        <button onclick="markAllNotificationsRead()" class="text-xs bg-blue-100 text-blue-600 px-3 py-2 rounded-xl hover:bg-blue-200 transition">âœ“ Ù‡Ù…Ù‡</button>
                        <button onclick="deleteAllNotifications()" class="text-xs bg-red-100 text-red-600 px-3 py-2 rounded-xl hover:bg-red-200 transition">ğŸ—‘ï¸</button>
                        <button onclick="toggleNotificationPanel()" class="text-2xl text-gray-400 hover:text-red-500 transition">&times;</button>
                    </div>
                </div>
                <div id="notifications-container" class="flex-1 overflow-y-auto p-4 space-y-3" style="max-height: calc(100vh - 100px);">
                    <div class="flex flex-col items-center justify-center h-64 text-gray-300">
                        <span class="text-6xl mb-4">ğŸ””</span>
                        <p>Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Ù…Ø¯Ø§Ù„ ÙˆØ±ÙˆØ¯ -->
        <div id="auth-modal" class="fixed inset-0 bg-black/80 backdrop-blur-md z-[200] hidden items-center justify-center p-4">
            <div class="bg-white w-full max-w-sm rounded-[30px] p-8 shadow-2xl text-center">
                <h2 class="text-2xl font-bold mb-6 text-gray-800">ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ø­Ø³Ø§Ø¨</h2>
                <input id="login-username" type="text" placeholder="Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ" class="w-full bg-gray-100 p-3 rounded-xl mb-3 outline-none text-right">
                <input id="login-password" type="password" placeholder="Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±" class="w-full bg-gray-100 p-3 rounded-xl mb-6 outline-none text-right">
                <button onclick="loginUser()" class="w-full bg-blue-600 text-white py-3 rounded-xl font-bold hover:bg-blue-700 transition">ÙˆØ±ÙˆØ¯</button>
                <button onclick="registerUser()" class="w-full bg-gray-50 text-gray-600 py-3 rounded-xl font-bold mt-2 hover:bg-gray-100">Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…</button>
                <p id="auth-error" class="text-red-500 text-xs mt-4 hidden"></p>
            </div>
        </div>

        <!-- Ù…Ø¯Ø§Ù„ Ø³Ø§Ø®Øª Ú¯Ø±ÙˆÙ‡ -->
        <div id="create-group-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-[100] hidden items-center justify-center p-4">
            <div class="bg-white w-full max-w-md rounded-[30px] shadow-2xl p-8">
                <h2 class="text-xl font-bold mb-4">Ø³Ø§Ø®Øª Ú¯Ø±ÙˆÙ‡ Ø¬Ø¯ÛŒØ¯</h2>
                <input type="text" id="group-name-input" placeholder="Ù†Ø§Ù… Ú¯Ø±ÙˆÙ‡..." class="w-full bg-gray-100 p-3 rounded-2xl mb-4 outline-none">
                <div class="mb-2 text-xs text-gray-500">Ø§ÙØ²ÙˆØ¯Ù† Ø§Ø¹Ø¶Ø§:</div>
                <input type="text" oninput="searchUsersForGroup(this.value)" placeholder="Ø¬Ø³ØªØ¬ÙˆÛŒ Ú©Ø§Ø±Ø¨Ø±..." class="w-full bg-gray-100 p-2 rounded-xl mb-2 outline-none text-sm">
                <div id="group-user-results" class="max-h-40 overflow-y-auto space-y-2 mb-6 border border-gray-100 p-2 rounded-xl"></div>
                <div class="flex gap-2">
                    <button onclick="submitCreateGroup()" class="flex-1 bg-blue-600 text-white py-3 rounded-2xl font-bold hover:bg-blue-700">Ø§ÛŒØ¬Ø§Ø¯</button>
                    <button onclick="closeModals()" class="flex-1 bg-gray-100 py-3 rounded-2xl hover:bg-gray-200">Ù„ØºÙˆ</button>
                </div>
            </div>
        </div>

        <!-- Ù…Ø¯Ø§Ù„ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú¯Ø±ÙˆÙ‡ -->
        <div id="group-info-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-[100] hidden items-center justify-center p-4">
            <div class="bg-white w-full max-w-md rounded-[30px] shadow-2xl overflow-hidden p-8 animate-in zoom-in duration-200">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold">Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú¯Ø±ÙˆÙ‡</h2>
                    <button onclick="closeModals()" class="text-2xl text-gray-400 hover:text-red-500">&times;</button>
                </div>
                <div class="flex flex-col items-center gap-3 mb-6">
                    <img id="info-group-img" src="" class="w-24 h-24 rounded-full object-cover border-4 border-blue-50 shadow-md">
                    <h3 id="info-group-name" class="font-bold text-xl text-gray-800"></h3>
                    <p id="info-group-bio" class="text-sm text-gray-500 text-center bg-gray-50 p-2 rounded-lg w-full"></p>
                    <button id="admin-edit-btn" onclick="openEditGroup()" class="hidden bg-blue-50 text-blue-600 px-4 py-2 rounded-xl text-xs font-bold hover:bg-blue-100 transition w-full">ÙˆÛŒØ±Ø§ÛŒØ´ Ù…Ø´Ø®ØµØ§Øª Ú¯Ø±ÙˆÙ‡ âœï¸</button>
                </div>
                <div class="text-xs font-bold text-gray-400 mb-3 uppercase tracking-wide">Ø§Ø¹Ø¶Ø§</div>
                <div id="member-list-container" class="space-y-3 max-h-60 overflow-y-auto pb-4 messages-container"></div>
            </div>
        </div>

        <!-- Ù…Ø¯Ø§Ù„ ÙˆÛŒØ±Ø§ÛŒØ´ Ú¯Ø±ÙˆÙ‡ -->
        <div id="edit-group-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-[110] hidden items-center justify-center p-4">
            <div class="bg-white w-full max-w-md rounded-[30px] shadow-2xl p-8 animate-in zoom-in duration-200">
                <h2 class="text-xl font-bold mb-6">ÙˆÛŒØ±Ø§ÛŒØ´ Ú¯Ø±ÙˆÙ‡</h2>
                <div class="flex flex-col items-center gap-4">
                    <div class="relative cursor-pointer group" onclick="document.getElementById('group-avatar-input').click()">
                        <img id="edit-group-avatar-preview" src="" class="w-24 h-24 rounded-full object-cover border-4 border-blue-100 group-hover:opacity-70 transition">
                        <div class="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 transition"><span class="bg-black/50 text-white text-xs px-2 py-1 rounded">ØªØºÛŒÛŒØ±</span></div>
                        <input type="file" id="group-avatar-input" class="hidden" accept="image/*" onchange="previewGroupAvatar(this)">
                    </div>
                    <input type="text" id="edit-group-name" class="w-full bg-gray-50 p-3 rounded-2xl outline-none border border-transparent focus:border-blue-500 transition" placeholder="Ù†Ø§Ù… Ú¯Ø±ÙˆÙ‡">
                    <textarea id="edit-group-bio" rows="2" class="w-full bg-gray-50 p-3 rounded-2xl outline-none border border-transparent focus:border-blue-500 transition" placeholder="Ø¨ÛŒÙˆÚ¯Ø±Ø§ÙÛŒ"></textarea>
                    <div class="flex gap-2 w-full">
                        <button onclick="saveGroupDetails()" class="flex-1 bg-blue-600 text-white py-3 rounded-2xl font-bold hover:bg-blue-700 shadow-md">Ø°Ø®ÛŒØ±Ù‡</button>
                        <button onclick="document.getElementById('edit-group-modal').classList.remove('modal-active')" class="flex-1 bg-gray-100 text-gray-600 py-3 rounded-2xl font-bold hover:bg-gray-200">Ù„ØºÙˆ</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Ù…Ø¯Ø§Ù„ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù¾Ø±ÙˆÙØ§ÛŒÙ„ -->
        <div id="settings-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-[100] hidden items-center justify-center p-4">
            <div class="bg-white w-full max-w-md rounded-[30px] shadow-2xl p-8">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold">Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ù…Ù†</h2>
                    <button onclick="closeModals()" class="text-2xl text-gray-400">&times;</button>
                </div>
                <div class="flex flex-col items-center gap-4">
                    <div class="relative cursor-pointer group" onclick="document.getElementById('avatar-input').click()">
                        <img id="edit-avatar-preview" src="" class="w-24 h-24 rounded-full object-cover border-4 border-blue-100 group-hover:opacity-70 transition">
                        <div class="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 transition"><span class="bg-black/50 text-white text-xs px-2 py-1 rounded">ØªØºÛŒÛŒØ±</span></div>
                        <input type="file" id="avatar-input" class="hidden" accept="image/*" onchange="previewAvatar(this)">
                    </div>
                    <input type="text" id="edit-username" class="w-full bg-gray-50 p-3 rounded-2xl outline-none" placeholder="Ù†Ø§Ù… Ø´Ù…Ø§">
                    <textarea id="edit-bio" rows="2" class="w-full bg-gray-50 p-3 rounded-2xl outline-none" placeholder="Ø¨ÛŒÙˆÚ¯Ø±Ø§ÙÛŒ"></textarea>
                    <button onclick="saveProfile()" class="w-full bg-blue-600 text-white py-3 rounded-2xl font-bold shadow-lg hover:bg-blue-700">Ø°Ø®ÛŒØ±Ù‡ ØªØºÛŒÛŒØ±Ø§Øª</button>
                </div>
            </div>
        </div>

    </div>

    <!-- Ú©Ø§Ù†ØªÛŒÙ†Ø± Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù†â€ŒÙ‡Ø§ÛŒ Ù„Ø­Ø¸Ù‡â€ŒØ§ÛŒ -->
    <div id="notification-toast-container" class="fixed top-4 left-4 z-[1000] space-y-2"></div>

    <script>
    const API_BASE = "http://127.0.0.1:8001/api";
    let currentToken = localStorage.getItem("access");
    let myId = localStorage.getItem("user_id");
    let myUsername = localStorage.getItem("my_username");
    let activeChatId = null;
    let activeChatData = null;
    let socket = null;
    let notificationSocket = null;
    let selectedUserIds = [];
    let mediaRecorder;
    let audioChunks = [];
    let isRecording = false;
    let typingTimeout = null;
    let isConnecting = false;
    let selectChatTimeout = null;
    let notificationSound = null;
    let searchTimeout = null;

    // ================ Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª ================
    function checkAuth() {
        if (!currentToken) {
            document.getElementById('auth-modal').classList.remove('hidden');
            document.getElementById('auth-modal').style.display = 'flex';
        } else {
            document.getElementById('auth-modal').style.display = 'none';
            document.getElementById('my-name-display').innerText = `Ú©Ø§Ø±Ø¨Ø±: ${myUsername || '...'}`;
            loadChats();
            connectNotificationWebSocket();
            updateNotificationBadge();
            setupTypingHandler();
        }
    }

    async function loginUser() {
        const u = document.getElementById('login-username').value;
        const p = document.getElementById('login-password').value;
        try {
            const res = await axios.post(`${API_BASE}/login/`, { username: u, password: p });
            localStorage.setItem("access", res.data.access);
            const prof = await axios.get(`${API_BASE}/profile/`, { 
                headers: { Authorization: `Bearer ${res.data.access}` } 
            });
            localStorage.setItem("user_id", prof.data.id);
            localStorage.setItem("my_username", prof.data.username);
            location.reload();
        } catch (e) { 
            document.getElementById('auth-error').innerText = "Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ø³Øª"; 
            document.getElementById('auth-error').classList.remove('hidden'); 
        }
    }

    async function registerUser() {
        const u = document.getElementById('login-username').value;
        const p = document.getElementById('login-password').value;
        if(!u || !p) return alert("Ù„Ø·ÙØ§ ÙÛŒÙ„Ø¯Ù‡Ø§ Ø±Ø§ Ù¾Ø± Ú©Ù†ÛŒØ¯");
        try {
            await axios.post(`${API_BASE}/register/`, { 
                username: u, 
                password: p, 
                email: u + "@mail.com" 
            });
            await loginUser();
        } catch (e) { 
            alert(e.response?.data?.error || "Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…");
        }
    }

    // ================ Ù„ÛŒØ³Øª Ú†Øªâ€ŒÙ‡Ø§ ================
    async function loadChats() {
        try {
            const res = await axios.get(`${API_BASE}/my-chats/`, { 
                headers: { Authorization: `Bearer ${currentToken}` } 
            });
            const list = document.getElementById('chat-list');
            
            if(res.data.length === 0) {
                list.innerHTML = `<div class="flex flex-col items-center mt-10 opacity-50">
                    <span class="text-4xl mb-2">ğŸ“­</span>
                    <p>Ù‡Ù†ÙˆØ² Ú†ØªÛŒ Ù†Ø¯Ø§Ø±ÛŒØ¯</p>
                </div>`;
                return;
            }

            list.innerHTML = res.data.map(chat => {
                let name, img, typeLabel = "";
                if (chat.chat_type === 'private') {
                    const other = chat.private_info.user1 == myId 
                        ? chat.private_info.user2_details 
                        : chat.private_info.user1_details;
                    name = other?.username || "Ú©Ø§Ø±Ø¨Ø±"; 
                    img = other?.profile_pic || 'https://via.placeholder.com/50';
                    typeLabel = "Ø´Ø®ØµÛŒ";
                } else {
                    name = chat.group_info?.group_name || "Ú¯Ø±ÙˆÙ‡ Ø¨Ø¯ÙˆÙ† Ù†Ø§Ù…";
                    img = chat.group_info?.group_image || 'https://via.placeholder.com/50';
                    typeLabel = "Ú¯Ø±ÙˆÙ‡";
                }
                
                const lastMsg = chat.last_message 
                    ? (chat.last_message.content || 'ÙØ§ÛŒÙ„/ÙˆÛŒØ³') 
                    : 'Ù¾ÛŒØ§Ù…ÛŒ Ù†ÛŒØ³Øª';
                const time = chat.last_message 
                    ? new Date(chat.last_message.timestamp).toLocaleTimeString('fa-IR', {
                        hour: '2-digit', 
                        minute: '2-digit'
                    }) : '';

                const chatData = JSON.stringify(chat).replace(/"/g, '&quot;');
                
                return `
                <div data-chat-id="${chat.chat_id}" 
                     data-chat-data='${chatData}'
                     data-chat-name="${name}"
                     data-chat-img="${img}"
                     onclick="handleChatClick(this)" 
                     class="flex items-center gap-3 p-3 mb-1 rounded-2xl cursor-pointer transition border border-transparent hover:bg-gray-50 hover:border-gray-100 ${activeChatId == chat.chat_id ? 'bg-blue-50 border-blue-100' : ''}">
                    <img src="${img}" class="w-12 h-12 rounded-full object-cover shadow-sm bg-white">
                    <div class="flex-1 min-w-0">
                        <div class="flex justify-between items-center mb-1">
                            <h4 class="font-bold text-gray-800 text-sm truncate">${name}</h4>
                            <span class="text-[10px] text-gray-400">${time}</span>
                        </div>
                        <div class="flex justify-between">
                            <p class="text-xs text-gray-500 truncate w-32 h-4">${lastMsg}</p>
                            <span class="text-[9px] bg-gray-100 px-1 rounded text-gray-500">${typeLabel}</span>
                        </div>
                    </div>
                </div>`;
            }).join('');
            
        } catch (e) { 
            console.error('Error loading chats:', e); 
        }
    }

    function handleChatClick(element) {
        const chatId = element.dataset.chatId;
        const chatData = JSON.parse(element.dataset.chatData);
        const name = element.dataset.chatName;
        const img = element.dataset.chatImg;
        selectChat(chatData, name, img);
    }


    function setupTypingHandler() {
    const input = document.getElementById('msg-input');
    if (!input) return;
    
    // Remove existing listeners
    if (input._listenerAdded) {
        input.removeEventListener('input', input._typingHandler);
        input.removeEventListener('keypress', input._keypressHandler);
    }
    
    input._typingHandler = function() {
        if (socket?.readyState === 1 && activeChatId) {
            // Send typing start
            socket.send(JSON.stringify({ 
                type: 'typing', 
                is_typing: true 
            }));
            
            // Clear previous timeout
            if (typingTimeout) clearTimeout(typingTimeout);
            
            // Set timeout to send typing stop after 2 seconds of inactivity
            typingTimeout = setTimeout(() => {
                if (socket?.readyState === 1) {
                    socket.send(JSON.stringify({ 
                        type: 'typing', 
                        is_typing: false 
                    }));
                    console.log('âœï¸ Typing stopped (timeout)');
                }
            }, 2000);
        }
    };
    
    input._keypressHandler = function(e) {
        if (e.key === "Enter") {
            sendText();
            // Immediately send typing stop when sending message
            if (socket?.readyState === 1) {
                socket.send(JSON.stringify({ 
                    type: 'typing', 
                    is_typing: false 
                }));
            }
        }
    };
    
    // Send typing stop when input loses focus
    input._blurHandler = function() {
        if (socket?.readyState === 1) {
            socket.send(JSON.stringify({ 
                type: 'typing', 
                is_typing: false 
            }));
            console.log('âœï¸ Typing stopped (blur)');
        }
    };
    
    input.addEventListener('input', input._typingHandler);
    input.addEventListener('keypress', input._keypressHandler);
    input.addEventListener('blur', input._blurHandler);
    input._listenerAdded = true;
    
    console.log('âœ… Typing handler setup complete');
}


    function selectChat(data, name, img) {
        if (!data || !data.chat_id) {
            console.error('Invalid chat data:', data);
            return;
        }
        
        if (selectChatTimeout) {
            clearTimeout(selectChatTimeout);
        }
        
        selectChatTimeout = setTimeout(() => {
            if (activeChatId === data.chat_id) {
                document.getElementById('messages-box').scrollTop = document.getElementById('messages-box').scrollHeight;
                return;
            }
            
            document.getElementById('messages-box').innerHTML = `
                <div class="flex flex-col items-center justify-center h-full text-gray-300">
                    <span class="text-6xl mb-4">ğŸ”„</span>
                    <p>Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</p>
                </div>
            `;
            
            activeChatId = data.chat_id;
            activeChatData = data;
            
            document.getElementById('active-user-name').innerText = name;
            document.getElementById('active-user-img').src = img;
            document.getElementById('input-area').classList.remove('opacity-50', 'pointer-events-none');
            
            updateActiveChatStyle();
            
            if (socket) {
                socket.onclose = null;
                socket.close();
                socket = null;
            }
            
            openChat(activeChatId);
        }, 100);
    }

    function updateActiveChatStyle() {
        const chatItems = document.querySelectorAll('#chat-list > div[data-chat-id]');
        chatItems.forEach(item => {
            if (item.dataset.chatId == activeChatId) {
                item.classList.add('bg-blue-50', 'border-blue-100');
            } else {
                item.classList.remove('bg-blue-50', 'border-blue-100');
            }
        });
    }

    // ================ Ø¬Ø³ØªØ¬ÙˆÛŒ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ùˆ Ø´Ø±ÙˆØ¹ Ú†Øª Ø®ØµÙˆØµÛŒ ================
    function debounceSearchUsers(query) {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            searchUsers(query);
        }, 500);
    }

    async function searchUsers(query) {
        if (!query || query.length < 2) {
            const existingResults = document.getElementById('user-search-results');
            if (existingResults) existingResults.remove();
            return;
        }
        
        try {
            const res = await axios.get(`${API_BASE}/search-users/?search=${encodeURIComponent(query)}`, {
                headers: { Authorization: `Bearer ${currentToken}` }
            });
            
            displayUserSearchResults(res.data);
        } catch (e) {
            console.error('Error searching users:', e);
        }
    }

    function displayUserSearchResults(users) {
        const existingResults = document.getElementById('user-search-results');
        if (existingResults) existingResults.remove();
        
        if (users.length === 0) return;
        
        const resultsDiv = document.createElement('div');
        resultsDiv.id = 'user-search-results';
        resultsDiv.className = 'absolute z-50 w-80 mt-1 bg-white rounded-2xl shadow-2xl border border-gray-200 max-h-80 overflow-y-auto p-2';
        
        const searchInput = document.getElementById('search-users-input');
        const rect = searchInput.getBoundingClientRect();
        resultsDiv.style.top = rect.bottom + window.scrollY + 8 + 'px';
        resultsDiv.style.left = rect.left + window.scrollX + 'px';
        resultsDiv.style.width = rect.width + 'px';
        
        resultsDiv.innerHTML = users.map(user => `
            <div onclick="startPrivateChat(${user.id}, '${user.username}', '${user.profile_pic || ''}')" 
                 class="flex items-center gap-3 p-3 rounded-xl cursor-pointer hover:bg-blue-50 transition-all duration-200 group">
                <img src="${user.profile_pic || 'https://via.placeholder.com/40'}" 
                     class="w-10 h-10 rounded-full object-cover border-2 border-transparent group-hover:border-blue-500">
                <div class="flex-1">
                    <div class="flex justify-between items-center">
                        <span class="font-bold text-sm text-gray-800">${user.username}</span>
                        <span class="text-xs text-gray-400">${user.is_online ? 'ğŸŸ¢ Ø¢Ù†Ù„Ø§ÛŒÙ†' : 'âšª Ø¢ÙÙ„Ø§ÛŒÙ†'}</span>
                    </div>
                    <span class="text-xs text-gray-500">${user.bio || 'Ù¾ÛŒØ§Ù… Ø®ØµÙˆØµÛŒ'}</span>
                </div>
                <button class="text-blue-600 opacity-0 group-hover:opacity-100 transition">ğŸ’¬</button>
            </div>
        `).join('');
        
        document.addEventListener('click', function closeSearch(e) {
            if (!resultsDiv.contains(e.target) && e.target !== searchInput) {
                resultsDiv.remove();
                document.removeEventListener('click', closeSearch);
            }
        });
        
        document.body.appendChild(resultsDiv);
    }

    async function startPrivateChat(userId, username, profilePic) {
        try {
            const loadingToast = document.createElement('div');
            loadingToast.className = 'fixed top-4 right-4 bg-blue-600 text-white px-4 py-2 rounded-xl shadow-lg z-50';
            loadingToast.innerText = 'Ø¯Ø± Ø­Ø§Ù„ Ø§ÛŒØ¬Ø§Ø¯ Ú†Øª...';
            document.body.appendChild(loadingToast);
            
            const res = await axios.post(`${API_BASE}/start-chat/${userId}/`, {}, {
                headers: { Authorization: `Bearer ${currentToken}` }
            });
            
            loadingToast.remove();
            
            const chat = res.data;
            const name = username;
            const img = profilePic || 'https://via.placeholder.com/50';
            
            selectChat(chat, name, img);
            
            const results = document.getElementById('user-search-results');
            if (results) results.remove();
            
            document.getElementById('search-users-input').value = '';
            
        } catch (e) {
            console.error('Error starting private chat:', e);
            alert('Ø®Ø·Ø§ Ø¯Ø± Ø§ÛŒØ¬Ø§Ø¯ Ú†Øª Ø®ØµÙˆØµÛŒ');
        }
    }

    // ================ Ú†Øª Ùˆ WebSocket ================
    async function openChat(id) {
        if (isConnecting) {
            console.log('Ø¯Ø± Ø­Ø§Ù„ Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ú†Øª Ø¯ÛŒÚ¯Ø±...');
            return;
        }
        
        isConnecting = true;
        
        try {
            const res = await axios.get(`${API_BASE}/chat-history/${id}/`, { 
                headers: { Authorization: `Bearer ${currentToken}` } 
            });
            
            renderMessages(res.data);
            console.log('âœ… ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ú†Øª Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø´Ø¯:', res.data.length, 'Ù¾ÛŒØ§Ù…');
            
            setupChatWebSocket(id);
            
        } catch (e) {
            console.error('âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ú†Øª:', e);
            document.getElementById('messages-box').innerHTML = `
                <div class="flex flex-col items-center justify-center h-full text-red-500">
                    <span class="text-6xl mb-4">âš ï¸</span>
                    <p>Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§</p>
                </div>
            `;
        } finally {
            isConnecting = false;
        }
    }

    function setupChatWebSocket(id) {
        if (socket) {
            socket.onclose = null;
            socket.close();
            socket = null;
        }
        
        socket = new WebSocket(`ws://127.0.0.1:8001/ws/chat/${id}/?token=${currentToken}`);
        
        socket.onopen = () => {
            console.log('âœ… WebSocket Ú†Øª Ù…ØªØµÙ„ Ø´Ø¯:', id);
        };
        
        socket.onmessage = (e) => {
            try {
                const data = JSON.parse(e.data);
                
                if (data.type === 'chat_message') {
                    addSingleMessage(data);
                    updateLastMessage(id, data.message || 'ÙØ§ÛŒÙ„ Ø¬Ø¯ÛŒØ¯');
                    
                    if (data.sender_id != myId && activeChatId != id) {
                        showMessageNotification(data);
                    }
                    
                } else if (data.type === 'message_updated') {
                    const el = document.querySelector(`.msg-text-${data.msg_id}`);
                    if(el) { 
                        el.innerText = data.new_content; 
                        const flag = el.parentElement?.querySelector('.edited-flag');
                        if (flag) flag.innerText = "(ÙˆÛŒØ±Ø§ÛŒØ´ Ø´Ø¯Ù‡)";
                    }
                } else if (data.type === 'message_deleted') {
                    const el = document.getElementById(`msg-row-${data.msg_id}`);
                    if(el) el.remove();
                    
                } else if (data.type === 'user_typing' && data.sender_id != myId) {
                    const typingEl = document.getElementById('typing-status');
                    if(data.is_typing) { 
                        typingEl.classList.remove('hidden'); 
                        typingEl.innerText = `${data.sender} Ù…ÛŒâ€ŒÙ†ÙˆÛŒØ³Ø¯...`; 
                    } else {
                        typingEl.classList.add('hidden');
                    }
                } else if (data.type === 'user_status') {
                    if (activeChatData?.chat_type === 'private') {
                        const otherId = activeChatData.private_info.user1 == myId 
                            ? activeChatData.private_info.user2 
                            : activeChatData.private_info.user1;
                        
                        if (data.user_id == otherId) {
                            const statusEl = document.getElementById('online-status');
                            if (data.status === 'online') {
                                statusEl.classList.remove('hidden');
                                statusEl.innerText = 'â— Ø¢Ù†Ù„Ø§ÛŒÙ†';
                            } else {
                                statusEl.classList.add('hidden');
                            }
                        }
                    }
                }
            } catch (err) {
                console.error('Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø±Ø¯Ø§Ø²Ø´ Ù¾ÛŒØ§Ù… WebSocket:', err);
            }
        };
        
        socket.onclose = (e) => {
            console.log('âŒ WebSocket Ú†Øª Ù‚Ø·Ø¹ Ø´Ø¯:', id);
            if (activeChatId === id && !e.wasClean) {
                console.log('ğŸ”„ ØªÙ„Ø§Ø´ Ø¨Ø±Ø§ÛŒ Ø§ØªØµØ§Ù„ Ù…Ø¬Ø¯Ø¯...');
                setTimeout(() => {
                    if (activeChatId === id) {
                        setupChatWebSocket(id);
                    }
                }, 3000);
            }
        };
        
        socket.onerror = (e) => {
            console.error('âš ï¸ Ø®Ø·Ø§ÛŒ WebSocket:', id);
        };
    }

    function updateLastMessage(chatId, message) {
        const chatItem = document.querySelector(`#chat-list div[data-chat-id="${chatId}"]`);
        if (chatItem) {
            const msgEl = chatItem.querySelector('p.text-xs.text-gray-500');
            if (msgEl) {
                msgEl.innerText = message.length > 30 ? message.substring(0, 30) + '...' : message;
            }
            
            const timeEl = chatItem.querySelector('span.text-\\[10px\\].text-gray-400');
            if (timeEl) {
                const now = new Date();
                timeEl.innerText = now.toLocaleTimeString('fa-IR', {
                    hour: '2-digit', 
                    minute: '2-digit'
                });
            }
        }
    }

    function addChatToList(chat) {
        const existingChat = document.querySelector(`#chat-list div[data-chat-id="${chat.chat_id}"]`);
        if (existingChat) return;
        
        let name, img, typeLabel = "";
        if (chat.chat_type === 'private') {
            const other = chat.private_info.user1 == myId 
                ? chat.private_info.user2_details 
                : chat.private_info.user1_details;
            name = other?.username || "Ú©Ø§Ø±Ø¨Ø±"; 
            img = other?.profile_pic || 'https://via.placeholder.com/50';
            typeLabel = "Ø´Ø®ØµÛŒ";
        } else {
            name = chat.group_info?.group_name || "Ú¯Ø±ÙˆÙ‡ Ø¨Ø¯ÙˆÙ† Ù†Ø§Ù…";
            img = chat.group_info?.group_image || 'https://via.placeholder.com/50';
            typeLabel = "Ú¯Ø±ÙˆÙ‡";
        }
        
        const lastMsg = chat.last_message 
            ? (chat.last_message.content || 'ÙØ§ÛŒÙ„/ÙˆÛŒØ³') 
            : 'Ù¾ÛŒØ§Ù…ÛŒ Ù†ÛŒØ³Øª';
        const time = chat.last_message 
            ? new Date(chat.last_message.timestamp).toLocaleTimeString('fa-IR', {
                hour: '2-digit', 
                minute: '2-digit'
            }) : '';
        
        const chatData = JSON.stringify(chat).replace(/"/g, '&quot;');
        
        const chatHtml = `
            <div data-chat-id="${chat.chat_id}" 
                 data-chat-data='${chatData}'
                 data-chat-name="${name}"
                 data-chat-img="${img}"
                 onclick="handleChatClick(this)" 
                 class="flex items-center gap-3 p-3 mb-1 rounded-2xl cursor-pointer transition border border-transparent hover:bg-gray-50 hover:border-gray-100 animate-in slide-in-from-top duration-300">
                <img src="${img}" class="w-12 h-12 rounded-full object-cover shadow-sm bg-white">
                <div class="flex-1 min-w-0">
                    <div class="flex justify-between items-center mb-1">
                        <h4 class="font-bold text-gray-800 text-sm truncate">${name}</h4>
                        <span class="text-[10px] text-gray-400">${time}</span>
                    </div>
                    <div class="flex justify-between">
                        <p class="text-xs text-gray-500 truncate w-32 h-4">${lastMsg}</p>
                        <span class="text-[9px] bg-gray-100 px-1 rounded text-gray-500">${typeLabel}</span>
                    </div>
                </div>
            </div>
        `;
        
        const chatList = document.getElementById('chat-list');
        
        if (chatList.children.length === 1 && chatList.children[0].querySelector('p')?.innerText === 'Ù‡Ù†ÙˆØ² Ú†ØªÛŒ Ù†Ø¯Ø§Ø±ÛŒØ¯') {
            chatList.innerHTML = '';
        }
        
        chatList.insertAdjacentHTML('afterbegin', chatHtml);
    }

    // ================ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ ================
    function createMsgHTML(m) {
        const sender = m.sender_details ? m.sender_details.username : (m.sender_username || m.sender || "Ù†Ø§Ù…Ø´Ø®Øµ");
        const isMe = (m.sender == myId) || (sender === myUsername);
        
        let contentHtml = `<p class="text-sm leading-relaxed msg-text-${m.msg_id}">${m.content || m.message || ""}</p>`;
        const fUrl = m.file_url || (m.attachments?.length > 0 ? m.attachments[0].file : null);
        const type = m.type_str || (m.attachments?.length > 0 ? m.attachments[0].file_type : 'text');

        if (fUrl) {
            if (type === 'audio' || fUrl.match(/\.(webm|wav|mp3|ogg)$/i)) {
                contentHtml = `
                    <div class="flex items-center gap-2 mt-1 bg-white/10 p-2 rounded-xl" style="min-width: 220px;">
                        <audio controls class="h-8 w-full" style="filter: invert(${isMe ? 0 : 0.8});">
                            <source src="${fUrl}" type="audio/webm">
                            <source src="${fUrl}" type="audio/wav">
                            <source src="${fUrl}" type="audio/mp3">
                        </audio>
                    </div>`;
            } else if (type === 'image' || fUrl.match(/\.(jpg|jpeg|png|webp)$/i)) {
                contentHtml = `<img src="${fUrl}" class="rounded-lg mb-2 max-w-full shadow-sm">`;
            } else {
                contentHtml = `<a href="${fUrl}" target="_blank" class="flex items-center gap-2 bg-black/10 p-2 rounded-lg text-xs mt-1">ğŸ“„ Ø¯Ø§Ù†Ù„ÙˆØ¯ ÙØ§ÛŒÙ„</a>`;
            }
        }

        let actions = "";
        if (isMe) {
            actions = `
            <div class="flex gap-2 opacity-0 group-hover:opacity-50 transition-opacity">
                <button onclick="editMessage('${m.msg_id}', '${m.content || m.message}')" class="hover:text-blue-200" title="ÙˆÛŒØ±Ø§ÛŒØ´">âœï¸</button>
                <button onclick="deleteMessage('${m.msg_id}')" class="hover:text-red-300" title="Ø­Ø°Ù">ğŸ—‘ï¸</button>
            </div>`;
        }

        return `
        <div class="flex ${isMe ? 'justify-end' : 'justify-start'} w-full animate-in fade-in duration-300 group" id="msg-row-${m.msg_id}">
            <div class="${isMe ? 'bg-blue-600 text-white rounded-tr-none' : 'bg-white text-gray-800 rounded-tl-none shadow-sm border border-gray-100'} p-3 rounded-2xl max-w-[85%] text-right relative">
                <div class="flex justify-between items-center mb-1 gap-2 text-[10px]">
                    <span class="font-bold opacity-70">${isMe ? 'Ø´Ù…Ø§' : sender}</span>
                    ${actions}
                </div>
                ${contentHtml}
                <div class="flex justify-end items-center gap-1 mt-1">
                    <span class="edited-flag text-[8px] opacity-60">${m.is_edited ? '(ÙˆÛŒØ±Ø§ÛŒØ´ Ø´Ø¯Ù‡)' : ''}</span>
                    <span class="text-[8px] opacity-60 block dir-ltr">${m.timestamp ? new Date(m.timestamp).toLocaleTimeString('fa-IR', {hour:'2-digit', minute:'2-digit'}) : 'Ø§Ù„Ø§Ù†'}</span>
                </div>
            </div>
        </div>`;
    }

    function renderMessages(msgs) {
        const box = document.getElementById('messages-box');
        if (msgs.length === 0) {
            box.innerHTML = `<div class="flex flex-col items-center justify-center h-full text-gray-300">
                <span class="text-6xl mb-4">ğŸ’¬</span>
                <p>Ù‡Ù†ÙˆØ² Ù¾ÛŒØ§Ù…ÛŒ Ù†ÛŒØ³Øª</p>
            </div>`;
        } else {
            box.innerHTML = msgs.map(m => createMsgHTML(m)).join('');
        }
        box.scrollTop = box.scrollHeight;
    }

    function addSingleMessage(data) {
        const box = document.getElementById('messages-box');
        
        if (box.children.length === 1 && box.children[0].querySelector('p')?.innerText === 'Ù‡Ù†ÙˆØ² Ù¾ÛŒØ§Ù…ÛŒ Ù†ÛŒØ³Øª') {
            box.innerHTML = '';
        }
        
        const div = document.createElement('div');
        div.innerHTML = createMsgHTML(data);
        box.appendChild(div);
        box.scrollTop = box.scrollHeight;
    }

    function sendText() {
        const input = document.getElementById('msg-input');
        if (socket?.readyState === 1 && input.value.trim()) {
            socket.send(JSON.stringify({ 
                type: 'chat_message', 
                message: input.value.trim() 
            }));
            input.value = "";
        }
    }

    function setupTypingHandler() {
        const input = document.getElementById('msg-input');
        if (!input) return;
        
        if (input._listenerAdded) {
            input.removeEventListener('input', input._typingHandler);
            input.removeEventListener('keypress', input._keypressHandler);
        }
        
        input._typingHandler = function() {
            if (socket?.readyState === 1 && activeChatId) {
                socket.send(JSON.stringify({ 
                    type: 'typing', 
                    is_typing: true 
                }));
                if (typingTimeout) clearTimeout(typingTimeout);
                typingTimeout = setTimeout(() => {
                    if (socket?.readyState === 1) {
                        socket.send(JSON.stringify({ 
                            type: 'typing', 
                            is_typing: false 
                        }));
                    }
                }, 2000);
            }
        };
        
        input._keypressHandler = function(e) {
            if (e.key === "Enter") sendText();
        };
        
        input.addEventListener('input', input._typingHandler);
        input.addEventListener('keypress', input._keypressHandler);
        input._listenerAdded = true;
    }

    // ================ Ø¶Ø¨Ø· ØµØ¯Ø§ ================
    async function toggleVoiceRecording() {
        const btn = document.getElementById('voice-btn');
        
        if (!isRecording) {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                
                const options = { mimeType: 'audio/webm' };
                if (!MediaRecorder.isTypeSupported(options.mimeType)) {
                    console.warn("audio/webm not supported, fallback to default");
                    mediaRecorder = new MediaRecorder(stream);
                } else {
                    mediaRecorder = new MediaRecorder(stream, options);
                }

                audioChunks = [];
                mediaRecorder.ondataavailable = e => { 
                    if (e.data.size > 0) audioChunks.push(e.data); 
                };
                
                mediaRecorder.onstop = async () => {
                    const blob = new Blob(audioChunks, { type: 'audio/webm' });
                    if (blob.size < 500) return alert("ØµØ¯Ø§ÛŒÛŒ Ø¶Ø¨Ø· Ù†Ø´Ø¯");

                    const fd = new FormData();
                    fd.append('file', blob, `voice_${Date.now()}.webm`);
                    
                    try {
                        await axios.post(`${API_BASE}/upload/${activeChatId}/`, fd, { 
                            headers: { 
                                Authorization: `Bearer ${currentToken}`, 
                                'Content-Type': 'multipart/form-data' 
                            } 
                        });
                    } catch(e) { 
                        alert("Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ ÙˆÛŒØ³"); 
                    }
                    
                    stream.getTracks().forEach(t => t.stop());
                };

                mediaRecorder.start();
                isRecording = true;
                btn.innerText = "ğŸŸ¥";
                btn.classList.add('recording-active');
            } catch (err) { 
                alert("Ø¯Ø³ØªØ±Ø³ÛŒ Ù…ÛŒÚ©Ø±ÙˆÙÙˆÙ† Ø¯Ø§Ø¯Ù‡ Ù†Ø´Ø¯."); 
            }
        } else {
            if(mediaRecorder && mediaRecorder.state !== 'inactive') mediaRecorder.stop();
            isRecording = false;
            btn.innerText = "ğŸ¤";
            btn.classList.remove('recording-active');
        }
    }

    async function uploadFile() {
        const file = document.getElementById('file-input').files[0];
        if(!file) return;
        const fd = new FormData(); 
        fd.append('file', file);
        try {
            await axios.post(`${API_BASE}/upload/${activeChatId}/`, fd, { 
                headers: { 
                    Authorization: `Bearer ${currentToken}`, 
                    'Content-Type': 'multipart/form-data' 
                } 
            });
        } catch(e) {
            alert("Ø®Ø·Ø§ Ø¯Ø± Ø¢Ù¾Ù„ÙˆØ¯ ÙØ§ÛŒÙ„");
        }
    }

    // ================ ÙˆÛŒØ±Ø§ÛŒØ´ Ùˆ Ø­Ø°Ù Ù¾ÛŒØ§Ù… ================
    async function editMessage(id, txt) {
        const newTxt = prompt("ÙˆÛŒØ±Ø§ÛŒØ´ Ù…ØªÙ†:", txt);
        if(newTxt && newTxt !== txt) {
            try {
                await axios.patch(`${API_BASE}/edit-message/${id}/`, { 
                    content: newTxt 
                }, { 
                    headers: { Authorization: `Bearer ${currentToken}` } 
                });
            } catch(e) {
                alert("Ø®Ø·Ø§ Ø¯Ø± ÙˆÛŒØ±Ø§ÛŒØ´ Ù¾ÛŒØ§Ù…");
            }
        }
    }

    async function deleteMessage(id) {
        if(confirm("Ø­Ø°Ù Ø´ÙˆØ¯ØŸ")) {
            try {
                await axios.delete(`${API_BASE}/delete-message/${id}/`, { 
                    headers: { Authorization: `Bearer ${currentToken}` } 
                });
            } catch(e) {
                alert("Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù Ù¾ÛŒØ§Ù…");
            }
        }
    }

    async function blockUser(uid) {
        if(confirm("Ú©Ø§Ø±Ø¨Ø± Ø¨Ù„Ø§Ú© Ø´ÙˆØ¯ØŸ")) {
            try {
                await axios.post(`${API_BASE}/block/${uid}/`, {}, { 
                    headers: { Authorization: `Bearer ${currentToken}` } 
                });
                alert("Ø¨Ù„Ø§Ú© Ø´Ø¯");
                openGroupInfo();
            } catch(e) {
                alert("Ø®Ø·Ø§ Ø¯Ø± Ø¨Ù„Ø§Ú© Ú©Ø§Ø±Ø¨Ø±");
            }
        }
    }

    // ================ Ù…Ø¯ÛŒØ±ÛŒØª Ú¯Ø±ÙˆÙ‡ ================
    function openCreateGroupModal() {
        selectedUserIds = [];
        document.getElementById('group-user-results').innerHTML = "";
        document.getElementById('create-group-modal').classList.add('modal-active');
    }

    async function searchUsersForGroup(val) {
        if(val.length < 2) return;
        try {
            const res = await axios.get(`${API_BASE}/search-users/?search=${val}`, { 
                headers: { Authorization: `Bearer ${currentToken}` } 
            });
            document.getElementById('group-user-results').innerHTML = res.data.map(u => `
                <div class="flex justify-between items-center p-2 bg-gray-50 rounded-xl">
                    <span class="text-sm font-bold text-gray-700">${u.username}</span>
                    <button onclick="toggleSelectUser(${u.id}, this)" class="text-xs bg-gray-200 px-3 py-1 rounded-full hover:bg-blue-600 hover:text-white transition">Ø§ÙØ²ÙˆØ¯Ù†</button>
                </div>`).join('');
        } catch(e) {
            console.error('Search users failed:', e);
        }
    }

    function toggleSelectUser(id, btn) {
        if(selectedUserIds.includes(id)) {
            selectedUserIds = selectedUserIds.filter(i => i !== id);
            btn.innerText = "Ø§ÙØ²ÙˆØ¯Ù†"; 
            btn.classList.replace('bg-green-500', 'bg-gray-200'); 
            btn.classList.remove('text-white');
        } else {
            selectedUserIds.push(id);
            btn.innerText = "Ø§Ù†ØªØ®Ø§Ø¨"; 
            btn.classList.replace('bg-gray-200', 'bg-green-500'); 
            btn.classList.add('text-white');
        }
    }

    async function submitCreateGroup() {
        const name = document.getElementById('group-name-input').value;
        if(!name) return alert("Ù†Ø§Ù… Ú¯Ø±ÙˆÙ‡ØŸ");
        try {
            await axios.post(`${API_BASE}/create-group/`, { 
                name, 
                users: selectedUserIds 
            }, { 
                headers: { Authorization: `Bearer ${currentToken}` } 
            });
            closeModals(); 
            loadChats();
        } catch (e) { 
            alert("Ø®Ø·Ø§ Ø¯Ø± Ø³Ø§Ø®Øª Ú¯Ø±ÙˆÙ‡"); 
        }
    }

    async function openGroupInfo() {
        if(activeChatData?.chat_type !== 'group') {
            alert("Ø§ÛŒÙ† Ù‚Ø§Ø¨Ù„ÛŒØª ÙÙ‚Ø· Ø¨Ø±Ø§ÛŒ Ú¯Ø±ÙˆÙ‡â€ŒÙ‡Ø§ Ù‚Ø§Ø¨Ù„ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø³Øª");
            return;
        }
        try {
            const res = await axios.get(`${API_BASE}/group-details/${activeChatId}/`, { 
                headers: { Authorization: `Bearer ${currentToken}` } 
            });
            const d = res.data.details;
            
            document.getElementById('info-group-name').innerText = d.group_name;
            document.getElementById('info-group-bio').innerText = d.bio || "Ø¨Ø¯ÙˆÙ† Ø¨ÛŒÙˆÚ¯Ø±Ø§ÙÛŒ";
            document.getElementById('info-group-img').src = d.group_image || "https://via.placeholder.com/100";
            document.getElementById('admin-edit-btn').classList.toggle('hidden', !res.data.can_edit);
            
            document.getElementById('group-info-modal').classList.add('modal-active');
            fetchMembers();
        } catch(e) {
            console.error('Failed to load group details:', e);
        }
    }

    async function fetchMembers() {
        try {
            const res = await axios.get(`${API_BASE}/group-members/${activeChatId}/`, { 
                headers: { Authorization: `Bearer ${currentToken}` } 
            });
            const isAdmin = activeChatData.current_user_role?.is_admin;
            
            document.getElementById('member-list-container').innerHTML = res.data.map(m => `
                <div class="flex justify-between items-center bg-gray-50 p-3 rounded-2xl">
                    <div class="flex items-center gap-2">
                        <img src="${m.user_details.profile_pic || 'https://via.placeholder.com/30'}" class="w-8 h-8 rounded-full object-cover">
                        <span class="text-sm font-bold">${m.user_details.username} ${m.is_admin ? '<small class="text-blue-600">(Ø§Ø¯Ù…ÛŒÙ†)</small>' : ''}</span>
                    </div>
                    <div class="flex gap-1">
                        ${isAdmin && m.user != myId ? `
                            <button onclick="groupAction(${m.user}, 'promote')" class="text-[9px] bg-blue-100 text-blue-600 px-2 py-1 rounded-lg">Ø§Ø±ØªÙ‚Ø§</button>
                            <button onclick="groupAction(${m.user}, 'remove')" class="text-[9px] bg-red-100 text-red-600 px-2 py-1 rounded-lg">Ø­Ø°Ù</button>
                        ` : ''}
                        ${m.user != myId ? `
                            <button onclick="blockUser(${m.user})" class="text-[9px] bg-black text-white px-2 py-1 rounded-lg">Ø¨Ù„Ø§Ú©ğŸš«</button>
                        ` : ''}
                    </div>
                </div>`).join('');
        } catch(e) {
            console.error('Failed to fetch members:', e);
        }
    }

    async function groupAction(uid, action) {
        try {
            await axios.post(`${API_BASE}/group-action/${activeChatId}/`, { 
                user_id: uid, 
                action 
            }, { 
                headers: { Authorization: `Bearer ${currentToken}` } 
            });
            fetchMembers();
        } catch(e) {
            alert("Ø®Ø·Ø§ Ø¯Ø± Ø§Ù†Ø¬Ø§Ù… Ø¹Ù…Ù„ÛŒØ§Øª");
        }
    }

    function openEditGroup() {
        document.getElementById('group-info-modal').classList.remove('modal-active');
        document.getElementById('edit-group-name').value = document.getElementById('info-group-name').innerText;
        document.getElementById('edit-group-bio').value = document.getElementById('info-group-bio').innerText;
        document.getElementById('edit-group-avatar-preview').src = document.getElementById('info-group-img').src;
        document.getElementById('edit-group-modal').classList.add('modal-active');
    }

    async function saveGroupDetails() {
        const fd = new FormData();
        fd.append('group_name', document.getElementById('edit-group-name').value);
        fd.append('bio', document.getElementById('edit-group-bio').value);
        const av = document.getElementById('group-avatar-input').files[0];
        if(av) fd.append('group_image', av);
        try {
            await axios.patch(`${API_BASE}/group-update/${activeChatId}/`, fd, { 
                headers: { Authorization: `Bearer ${currentToken}` } 
            });
            location.reload();
        } catch(e) {
            alert("Ø®Ø·Ø§ Ø¯Ø± ÙˆÛŒØ±Ø§ÛŒØ´ Ú¯Ø±ÙˆÙ‡");
        }
    }

    // ================ Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù† ================
    function initNotificationSound() {
        try {
            notificationSound = new Audio();
            notificationSound.src = 'data:audio/wav;base64,U3R1ZmZz';
        } catch(e) {
            console.log('Audio not supported');
        }
    }

    function playNotificationSound() {
        try {
            if (notificationSound) {
                notificationSound.play().catch(e => console.log('Sound play failed:', e));
            }
        } catch(e) {
            console.log('Sound play failed:', e);
        }
    }

    function connectNotificationWebSocket() {
        if (!currentToken) return;
        
        if (notificationSocket) {
            notificationSocket.close();
        }

        console.log('ğŸ”” Ø§ØªØµØ§Ù„ Ø¨Ù‡ WebSocket Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù†...');
        notificationSocket = new WebSocket(`ws://127.0.0.1:8001/ws/notifications/?token=${currentToken}`);
        
        notificationSocket.onopen = function() {
            console.log('âœ… WebSocket Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù† Ù…ØªØµÙ„ Ø´Ø¯');
        };
        
        notificationSocket.onmessage = function(e) {
            try {
                const data = JSON.parse(e.data);
                console.log('ğŸ“¬ WebSocket message received:', data.type);
                
                if (data.type === 'notification') {
                    showNotificationToast(data.notification);
                    updateNotificationBadge();
                    
                    const panel = document.getElementById('notification-panel');
                    if (panel.classList.contains('active')) {
                        loadNotifications();
                    }
                } else if (data.type === 'chat_list_updated') {
                    console.log('ğŸ”„ Chat list update received:', data.chat);
                    addChatToList(data.chat);
                } else if (data.type === 'unread_notifications') {
                    console.log('ğŸ“‹ Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù†â€ŒÙ‡Ø§ÛŒ Ø®ÙˆØ§Ù†Ø¯Ù‡ Ù†Ø´Ø¯Ù‡:', data.notifications?.length);
                }
            } catch(err) {
                console.error('Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø±Ø¯Ø§Ø²Ø´ Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù†:', err);
            }
        };
        
        notificationSocket.onclose = function(e) {
            console.log('âŒ WebSocket Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù† Ù‚Ø·Ø¹ Ø´Ø¯. Ø§ØªØµØ§Ù„ Ù…Ø¬Ø¯Ø¯ Ø¯Ø± 3 Ø«Ø§Ù†ÛŒÙ‡...');
            setTimeout(connectNotificationWebSocket, 3000);
        };

        notificationSocket.onerror = function(e) {
            console.error('âš ï¸ Ø®Ø·Ø§ÛŒ WebSocket Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù†:', e);
        };
    }

    function showMessageNotification(data) {
        const notification = {
            id: 'msg-' + Date.now(),
            title: `Ù¾ÛŒØ§Ù… Ø¬Ø¯ÛŒØ¯ Ø§Ø² ${data.sender_username || data.sender}`,
            body: data.message || 'ÛŒÚ© Ù¾ÛŒØ§Ù… Ø¬Ø¯ÛŒØ¯',
            notification_type: 'message',
            time_ago: 'Ø§Ù„Ø§Ù†',
            data: {
                chat_id: data.chat_id,
                message_id: data.msg_id,
                sender_name: data.sender_username || data.sender
            }
        };
        showNotificationToast(notification);
        playNotificationSound();
        updateNotificationBadge();
    }

    function showNotificationToast(notification) {
        const container = document.getElementById('notification-toast-container');
        if (!container) return;
        
        const toastId = 'toast-' + Date.now();
        
        const icons = {
            'message': 'ğŸ’¬',
            'group_invite': 'ğŸ‘¥',
            'group_admin': 'ğŸ‘‘',
            'group_removed': 'ğŸš«',
            'mention': '@',
            'reply': 'â†©ï¸',
            'reaction': 'â¤ï¸',
            'call': 'ğŸ“'
        };
        
        const icon = icons[notification.notification_type] || 'ğŸ””';
        
        const toast = document.createElement('div');
        toast.id = toastId;
        toast.className = 'notification-toast bg-white shadow-2xl rounded-2xl p-4 border-r-4 border-blue-500 transform transition-all duration-300 hover:scale-102';
        toast.innerHTML = `
            <div class="flex items-start gap-3">
                <div class="text-2xl">${icon}</div>
                <div class="flex-1 min-w-0">
                    <div class="flex justify-between items-start">
                        <h4 class="font-bold text-sm text-gray-900 truncate">${notification.title || 'Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù† Ø¬Ø¯ÛŒØ¯'}</h4>
                        <span class="text-[10px] text-gray-400 whitespace-nowrap mr-2">${notification.time_ago || 'Ø§Ù„Ø§Ù†'}</span>
                    </div>
                    <p class="text-xs text-gray-600 mt-1 line-clamp-2">${notification.body || ''}</p>
                    <div class="flex justify-end mt-2">
                        <button onclick="openNotificationChat('${notification.data?.chat_id || ''}', '${notification.id}')" class="text-[10px] bg-blue-50 text-blue-600 px-3 py-1.5 rounded-full hover:bg-blue-100 transition">
                            Ù…Ø´Ø§Ù‡Ø¯Ù‡
                        </button>
                    </div>
                </div>
                <button onclick="this.closest('.notification-toast').remove()" class="text-gray-400 hover:text-gray-600 text-sm">âœ•</button>
            </div>
        `;
        
        container.appendChild(toast);
        playNotificationSound();
        
        setTimeout(() => {
            const toastEl = document.getElementById(toastId);
            if (toastEl) {
                toastEl.style.opacity = '0';
                toastEl.style.transform = 'translateX(-100%)';
                setTimeout(() => toastEl.remove(), 300);
            }
        }, 5000);
    }

    function toggleNotificationPanel() {
        const panel = document.getElementById('notification-panel');
        if (panel.classList.contains('active')) {
            panel.classList.remove('active');
        } else {
            panel.classList.add('active');
            loadNotifications();
        }
    }

    async function loadNotifications() {
        const container = document.getElementById('notifications-container');
        if (!container) return;
        
        try {
            const res = await axios.get(`${API_BASE}/notifications/`, {
                headers: { Authorization: `Bearer ${currentToken}` }
            });
            
            if (res.data.length === 0) {
                container.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-64 text-gray-300">
                        <span class="text-6xl mb-4">ğŸ””</span>
                        <p>Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù†ÛŒ Ù†Ø¯Ø§Ø±ÛŒØ¯</p>
                    </div>
                `;
                return;
            }
            
            const unreadCount = res.data.filter(n => !n.is_read).length;
            const panelUnread = document.getElementById('panel-unread-count');
            if (panelUnread) {
                panelUnread.innerText = unreadCount;
                panelUnread.classList.toggle('hidden', unreadCount === 0);
            }
            
            container.innerHTML = res.data.map(n => {
                const icons = {
                    'message': 'ğŸ’¬',
                    'group_invite': 'ğŸ‘¥',
                    'group_admin': 'ğŸ‘‘',
                    'group_removed': 'ğŸš«',
                    'mention': '@',
                    'reply': 'â†©ï¸',
                    'reaction': 'â¤ï¸',
                    'call': 'ğŸ“'
                };
                const icon = icons[n.notification_type] || 'ğŸ””';
                
                return `
                    <div class="notification-item ${!n.is_read ? 'unread' : ''} p-4 rounded-2xl cursor-pointer transition-all duration-200"
                         onclick="openNotificationChat('${n.data?.chat_id || ''}', '${n.id}')">
                        <div class="flex gap-3">
                            <div class="text-2xl">${icon}</div>
                            <div class="flex-1 min-w-0">
                                <div class="flex justify-between items-start mb-1">
                                    <h4 class="font-bold text-sm ${!n.is_read ? 'text-gray-900' : 'text-gray-600'} truncate">${n.title || ''}</h4>
                                    <span class="text-[9px] text-gray-400 whitespace-nowrap mr-2">${n.time_ago || ''}</span>
                                </div>
                                <p class="text-xs text-gray-600 line-clamp-2 mb-2">${n.body || ''}</p>
                                ${!n.is_read ? '<span class="text-[10px] bg-blue-500 text-white px-2 py-0.5 rounded-full">Ø¬Ø¯ÛŒØ¯</span>' : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
        } catch (e) {
            console.error('Failed to load notifications:', e);
            container.innerHTML = '<p class="text-center text-red-500 py-4">Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù†â€ŒÙ‡Ø§</p>';
        }
    }

    async function openNotificationChat(chatId, notificationId) {
        if (notificationId) {
            try {
                await axios.patch(`${API_BASE}/notifications/${notificationId}/`, {}, {
                    headers: { Authorization: `Bearer ${currentToken}` }
                });
                updateNotificationBadge();
            } catch (e) {
                console.error('Failed to mark notification as read:', e);
            }
        }
        
        if (chatId) {
            try {
                const res = await axios.get(`${API_BASE}/my-chats/`, {
                    headers: { Authorization: `Bearer ${currentToken}` }
                });
                
                const chat = res.data.find(c => c.chat_id == chatId);
                if (chat) {
                    let name, img;
                    if (chat.chat_type === 'private') {
                        const other = chat.private_info.user1 == myId 
                            ? chat.private_info.user2_details 
                            : chat.private_info.user1_details;
                        name = other?.username || 'Ú©Ø§Ø±Ø¨Ø±';
                        img = other?.profile_pic || 'https://via.placeholder.com/50';
                    } else {
                        name = chat.group_info?.group_name || 'Ú¯Ø±ÙˆÙ‡';
                        img = chat.group_info?.group_image || 'https://via.placeholder.com/50';
                    }
                    selectChat(chat, name, img);
                }
            } catch (e) {
                console.error('Failed to find chat:', e);
            }
        }
        
        toggleNotificationPanel();
    }

    async function markAllNotificationsRead() {
        try {
            await axios.post(`${API_BASE}/notifications/mark-all-read/`, {}, {
                headers: { Authorization: `Bearer ${currentToken}` }
            });
            loadNotifications();
            updateNotificationBadge();
        } catch (e) {
            console.error('Failed to mark all as read:', e);
        }
    }

    async function deleteAllNotifications() {
        if (!confirm('Ù‡Ù…Ù‡ Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù†â€ŒÙ‡Ø§ Ø­Ø°Ù Ø´ÙˆÙ†Ø¯ØŸ')) return;
        
        try {
            await axios.delete(`${API_BASE}/notifications/delete-all/`, {
                headers: { Authorization: `Bearer ${currentToken}` }
            });
            loadNotifications();
            updateNotificationBadge();
        } catch (e) {
            console.error('Failed to delete notifications:', e);
        }
    }

    async function updateNotificationBadge() {
        if (!currentToken) return;
        
        try {
            const res = await axios.get(`${API_BASE}/notifications/unread-count/`, {
                headers: { Authorization: `Bearer ${currentToken}` }
            });
            
            const count = res.data.unread_count;
            const badge = document.getElementById('notification-badge');
            
            if (count > 0) {
                badge.innerText = count > 99 ? '99+' : count;
                badge.classList.remove('hidden');
                document.title = `(${count}) LingoChat`;
            } else {
                badge.classList.add('hidden');
                document.title = 'LingoChat';
            }
        } catch (e) {
            console.error('Failed to update notification badge:', e);
        }
    }

    // ================ Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ùˆ ØªÙ†Ø¸ÛŒÙ…Ø§Øª ================
    function closeModals() { 
        document.querySelectorAll('[id$="-modal"]').forEach(m => { 
            if(m.id !== 'auth-modal') m.classList.remove('modal-active'); 
        }); 
    }

    async function openSettings() {
        try {
            const res = await axios.get(`${API_BASE}/profile/`, { 
                headers: { Authorization: `Bearer ${currentToken}` } 
            });
            document.getElementById('edit-username').value = res.data.username;
            document.getElementById('edit-bio').value = res.data.bio || "";
            document.getElementById('edit-avatar-preview').src = res.data.profile_pic || "https://via.placeholder.com/100";
            document.getElementById('settings-modal').classList.add('modal-active');
        } catch(e) {
            console.error('Failed to load profile:', e);
        }
    }

    async function saveProfile() {
        const fd = new FormData();
        fd.append('username', document.getElementById('edit-username').value);
        fd.append('bio', document.getElementById('edit-bio').value);
        const av = document.getElementById('avatar-input').files[0];
        if(av) fd.append('profile_pic', av);
        try {
            await axios.patch(`${API_BASE}/profile/`, fd, { 
                headers: { Authorization: `Bearer ${currentToken}` } 
            });
            localStorage.setItem("my_username", document.getElementById('edit-username').value);
            location.reload();
        } catch(e) {
            alert("Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ Ù¾Ø±ÙˆÙØ§ÛŒÙ„");
        }
    }

    function previewAvatar(input) { 
        if (input.files[0]) {
            document.getElementById('edit-avatar-preview').src = URL.createObjectURL(input.files[0]); 
        }
    }

    function previewGroupAvatar(input) { 
        if (input.files[0]) {
            document.getElementById('edit-group-avatar-preview').src = URL.createObjectURL(input.files[0]); 
        }
    }

    function logout() { 
        if(confirm("Ø®Ø§Ø±Ø¬ Ù…ÛŒâ€ŒØ´ÙˆÛŒØ¯ØŸ")) { 
            localStorage.clear(); 
            location.reload(); 
        } 
    }

    // ================ Ù…Ù‚Ø¯Ø§Ø±Ø¯Ù‡ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ ================
    initNotificationSound();
    checkAuth();
    
    setInterval(() => {
        if (currentToken) {
            updateNotificationBadge();
        }
    }, 30000);

    window.addEventListener('load', function() {
        if (currentToken) {
            setTimeout(() => {
                if (!notificationSocket || notificationSocket.readyState !== WebSocket.OPEN) {
                    console.log('ğŸ”„ Ø§ØªØµØ§Ù„ Ù…Ø¬Ø¯Ø¯ Ø¨Ù‡ WebSocket Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù†...');
                    connectNotificationWebSocket();
                }
            }, 1000);
        }
    });
</script>
</body>
</html>
